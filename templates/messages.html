{% extends "base.html" %}

{% block title %}Сообщения{% endblock %}

{% block content %}

<h1 class="mb-4">Сообщения с {{ friend_user.username }}</h1>

<button type="button" class="btn btn-secondary me-2 mb-3" onclick="loadMessages()">Обновить чат</button>

<button type="button" class="btn btn-warning mb-3" data-bs-toggle="modal" data-bs-target="#clearChatModal">Очистить чат</button>

<div class="chat-container">

{% for message in messages %}

<div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">

{% if message.content %}{{ message.content }}{% endif %}

{% if message.file_path %}

{% set filename = message.file_path.split('/')[-1] %}

{% set ext = filename.split('.')[-1].lower() %}

{% if ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'] %}

<img src="{{ url_for('download_chat', filename=message.file_path) }}" alt="{{ filename }}" style="max-width:200px; max-height:200px; border-radius:10px;">

{% elif ext in ['mp4', 'avi', 'mov', 'mkv', 'webm'] %}

<video controls style="max-width:200px; border-radius:10px;">

<source src="{{ url_for('download_chat', filename=message.file_path) }}" type="video/{{ ext }}">

Ваш браузер не поддерживает видео.

</video>

{% elif ext in ['mp3', 'wav', 'ogg', 'aac', 'flac'] %}

<audio controls style="max-width:200px;">

<source src="{{ url_for('download_chat', filename=message.file_path) }}" type="audio/{{ ext }}">

Ваш браузер не поддерживает аудио.

</audio>

{% else %}

<a href="{{ url_for('download_chat', filename=message.file_path) }}" class="btn btn-sm btn-outline-light">Скачать файл</a>

{% endif %}

{% endif %}

<small>{{ message.timestamp.strftime('%H:%M') }}</small>

{% if message.sender_id == current_user.id %}

<a href="{{ url_for('delete_message_for_me', message_id=message.id) }}" class="btn btn-sm btn-outline-warning ms-2">Удалить у себя</a>

<a href="{{ url_for('delete_message_for_all', message_id=message.id) }}" class="btn btn-sm btn-outline-danger ms-2">Удалить у всех</a>

{% endif %}

</div>

{% endfor %}

</div>

<form method="post" enctype="multipart/form-data">

    <div class="mb-3">

        <label class="form-label">Сообщение:</label>

        <textarea name="content" class="form-control"></textarea>

    </div>

    <div class="mb-3">

        <label class="form-label">Файл:</label>

        <input type="file" name="file" class="form-control">

    </div>

    <button type="submit" class="btn btn-success">Отправить</button>

</form>

<script>
window.onload = () => {
    setInterval(loadMessages, 3000);
};

function loadMessages() {
    fetch('/api/messages/{{ friend_user.id }}')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('chat-container');
        if (!container) return;
        container.innerHTML = '';
        data.forEach(msg => {
            const div = document.createElement('div');
            div.className = 'message ' + (msg.sender_id == {{ current_user.id }} ? 'sent' : 'received');
            let html = (msg.content || '') + (msg.file_path ? '<a href="/download_chat/' + msg.file_path + '" class="btn btn-sm btn-outline-light">Скачать файл</a>' : '') + '<small>' + msg.timestamp + '</small>';
            if (msg.sender_id == {{ current_user.id }}) {
                html += '<a href="/delete_message_for_me/' + msg.id + '" class="btn btn-sm btn-outline-warning ms-2">Удалить у себя</a><a href="/delete_message_for_all/' + msg.id + '" class="btn btn-sm btn-outline-danger ms-2">Удалить у всех</a>';
            }
            div.innerHTML = html;
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    });
}
</script>

<div class="modal fade" id="clearChatModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Подтверждение</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
Вы точно хотите очистить чат? Все сообщения будут удалены.
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Нет</button>
<form method="post" action="{{ url_for('clear_chat', user_id=friend_user.id) }}" style="display:inline;">
<button type="submit" class="btn btn-danger">Да</button>
</form>
</div>
</div>
</div>
</div>

{% endblock %}
